
<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Mapbox</title>
<meta name=viewport content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css' rel=stylesheet />
<script src="https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js"></script>
<script src="https://unpkg.com/scrollama"></script>
<script type="text/javascript" src="https://aesqe.github.io/mapboxgl-minimap/mapboxgl-control-minimap.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.0.0/mapbox-gl-geocoder.min.js'></script>
<link rel=stylesheet href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.0.0/mapbox-gl-geocoder.css' type='text/css'/>
<script src="https://cdn.rawgit.com/duroty/responsive/master/app.embed.js"></script>
<link rel=stylesheet href=global.css />
</head>
<body>
<div id=intro>
<h1>Los muros de la desigualdad</br> en España </h1>
<p id=autor>Clara Penín y Laura Aragó</p>
</div>
<div id=map>
</div>
<div id=story></div>
<script src="./config.js"></script>
<script>
        var layerTypes = {
            'fill': ['fill-opacity'],
            'line': ['line-opacity'],
            'circle': ['circle-opacity', 'circle-stroke-opacity'],
            'symbol': ['icon-opacity', 'text-opacity'],
            'raster': ['raster-opacity'],
            'fill-extrusion': ['fill-extrusion-opacity'],
            'heatmap': ['heatmap-opacity']
        }

        var alignments = {
            'left': 'lefty',
            'center': 'centered',
            'right': 'righty',
            'full': 'fully'
        }

        function getLayerPaintType(layer) {
            var layerType = map.getLayer(layer).type;
            return layerTypes[layerType];
        }

        function setLayerOpacity(layer) {
            var paintProps = getLayerPaintType(layer.layer);
            paintProps.forEach(function (prop) {
                var options = {};
                if (layer.duration) {
                    var transitionProp = prop + "-transition";
                    options = { "duration": layer.duration };
                    map.setPaintProperty(layer.layer, transitionProp, options);
                }
                map.setPaintProperty(layer.layer, prop, layer.opacity, options);
            });
        }

        var story = document.getElementById('story');
        var features = document.createElement('div');
        features.setAttribute('id', 'features');

        var header = document.createElement('div');

        if (config.title) {
            var titleText = document.createElement('h1');
            titleText.innerText = config.title;
            header.appendChild(titleText);
        }

        if (config.subtitle) {
            var subtitleText = document.createElement('h2');
            subtitleText.innerText = config.subtitle;
            header.appendChild(subtitleText);
        }

        if (config.byline) {
            var bylineText = document.createElement('p');
            bylineText.innerText = config.byline;
            header.appendChild(bylineText);
        }

        if (header.innerText.length > 0) {
            header.classList.add(config.theme);
            header.setAttribute('id', 'header');
            story.appendChild(header);
        }

        config.chapters.forEach((record, idx) => {
            var container = document.createElement('div');
            var chapter = document.createElement('div');

            if (record.title) {
                var title = document.createElement('h3');
                title.innerText = record.title;
                chapter.appendChild(title);
            }

            if (record.image) {
                var image = new Image();
                image.src = record.image;
                chapter.appendChild(image);
            }

            if (record.description) {
                var story = document.createElement('p');
                story.innerHTML = record.description;
                chapter.appendChild(story);
            }

            container.setAttribute('id', record.id);
            container.classList.add('step');
            if (idx === 0) {
                container.classList.add('active');
            }

            chapter.classList.add(config.theme);
            container.appendChild(chapter);
            container.classList.add(alignments[record.alignment] || 'centered');
            if (record.hidden) {
                container.classList.add('hidden');
            }
            features.appendChild(container);
        });

        story.appendChild(features);

        var footer = document.createElement('div');

        if (config.footer) {
            var footerText = document.createElement('p');
            footerText.innerHTML = config.footer;
            footer.appendChild(footerText);
        }

        if (footer.innerText.length > 0) {
            footer.classList.add(config.theme);
            footer.setAttribute('id', 'footer');
            story.appendChild(footer);
        }

        mapboxgl.accessToken = config.accessToken;

        const transformRequest = (url) => {
            const hasQuery = url.indexOf("?") !== -1;
            const suffix = hasQuery ? "&pluginName=scrollytellingV2" : "?pluginName=scrollytellingV2";
            return {
                url: url + suffix
            }
        }

        var map = new mapboxgl.Map({
            container: 'map',
            style: config.style,
            center: config.chapters[0].location.center,
            zoom: config.chapters[0].location.zoom,
            bearing: config.chapters[0].location.bearing,
            pitch: config.chapters[0].location.pitch,
            interactive: false,
            transformRequest: transformRequest
        });

        if (config.showMarkers) {
            var marker = new mapboxgl.Marker({ color: config.markerColor });
            marker.setLngLat(config.chapters[0].location.center).addTo(map);
        }

        // instantiate the scrollama
        var scroller = scrollama();

        map.on("load", function () {
            map.addSource("alquileres", {
                type: 'vector',
                //url: 'mapbox://laur05.62kefux9',
            });

            map.addSource("Girona", {
                type: 'geojson',
                data: {
            "type": "Feature",
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            2.8179931640625,
                            41.94065887682254
                        ],
                        [
                            2.816190719604492,
                            41.94199958840625
                        ],
                        [
                            2.8142166137695312,
                            41.94691528969935
                        ],
                        [
                            2.8125858306884766,
                            41.94806436002253
                        ],
                        [
                            2.810354232788086,
                            41.94863888741733
                        ],
                        [
                            2.809152603149414,
                            41.94838354254776
                        ],
                        [
                            2.806062698364258,
                            41.94946875117981
                        ],
                        [
                            2.8063201904296875,
                            41.94844737886103
                        ],
                        [
                            2.8055477142333984,
                            41.94857505129582
                        ],
                        [
                            2.8049468994140625,
                            41.949660256667755
                        ],
                        [
                            2.80426025390625,
                            41.948958067066
                        ],
                        [
                            2.8032302856445312,
                            41.94870272347492
                        ],
                        [
                            2.8032302856445312,
                            41.9492134096343
                        ],
                        [
                            2.802286148071289,
                            41.949724091702535
                        ],
                        [
                            2.8049468994140625,
                            41.95406472410133
                        ],
                        [
                            2.803316116333008,
                            41.955532812279756
                        ],
                        [
                            2.8031444549560547,
                            41.95680938320771
                        ],
                        [
                            2.798337936401367,
                            41.95814975516194
                        ],
                        [
                            2.7991104125976562,
                            41.96031982141187
                        ],
                        [
                            2.798337936401367,
                            41.96242599151276
                        ],
                        [
                            2.8000545501708984,
                            41.96325567577159
                        ],
                        [
                            2.800312042236328,
                            41.9659999390434
                        ],
                        [
                            2.8018569946289062,
                            41.9697013162106
                        ],
                        [
                            2.8008270263671875,
                            41.97002039038034
                        ],
                        [
                            2.801084518432617,
                            41.97180717619574
                        ],
                        [
                            2.8003978729248047,
                            41.97193480183611
                        ],
                        [
                            2.8011703491210938,
                            41.97410439859718
                        ],
                        [
                            2.8000545501708984,
                            41.977805304859004
                        ],
                        [
                            2.799968719482422,
                            41.983675266770064
                        ],
                        [
                            2.797822952270508,
                            41.985206472188224
                        ],
                        [
                            2.792329788208008,
                            41.985780664726036
                        ],
                        [
                            2.789154052734375,
                            41.98558926778884
                        ],
                        [
                            2.78310035005595,
                            41.984258328061465
                        ],
                        [
                            2.78310035005595,
                            41.98428889052876
                        ],
                        [
                            2.788209915161133,
                            41.98928950660158
                        ],
                        [
                            2.7979087829589844,
                            41.99573251255606
                        ],
                        [
                            2.8032302856445312,
                            42.000006225986596
                        ],
                        [
                            2.8039169311523438,
                            42.00102677181502
                        ],
                        [
                            2.8070068359375,
                            42.001913018418385
                        ],
                        [
                            2.8070068359375,
                            42.00191973598825
                        ],
                        [
                            2.808809280395508,
                            42.00242999560368
                        ],
                        [
                            2.8125858306884766,
                            41.998028871866495
                        ],
                        [
                            2.8136157989501953,
                            41.99866673474756
                        ],
                        [
                            2.8133583068847656,
                            41.99904944940724
                        ],
                        [
                            2.815675735473633,
                            42.00019757957617
                        ],
                        [
                            2.8196239471435547,
                            42.00134568902976
                        ],
                        [
                            2.8179931640625,
                            42.00417332529288
                        ],
                        [
                            2.8179931640625,
                            42.00408831109371
                        ],
                        [
                            2.8173065185546875,
                            42.005363908982616
                        ],
                        [
                            2.8173065185546875,
                            42.00778747451241
                        ],
                        [
                            2.819538116455078,
                            42.0107849146882
                        ],
                        [
                            2.825632095336914,
                            42.013973525781154
                        ],
                        [
                            2.8273487091064453,
                            42.01588661570966
                        ],
                        [
                            2.8278636932373047,
                            42.01748081335808
                        ],
                        [
                            2.827434539794922,
                            42.02130672466606
                        ],
                        [
                            2.829751968383789,
                            42.02628006523446
                        ],
                        [
                            2.832326889038086,
                            42.02793775897419
                        ],
                        [
                            2.8406524658203125,
                            42.02972291927631
                        ],
                        [
                            2.847003936767578,
                            42.029149123217735
                        ],
                        [
                            2.848634719848633,
                            42.02812902854728
                        ],
                        [
                            2.851552963256836,
                            42.0241122466613
                        ],
                        [
                            2.8488922119140625,
                            42.02130672466606
                        ],
                        [
                            2.849750518798828,
                            42.01990391724706
                        ],
                        [
                            2.848978042602539,
                            42.018883674231546
                        ],
                        [
                            2.8499221801757812,
                            42.01760834744354
                        ],
                        [
                            2.8498363494873047,
                            42.01550400232762
                        ],
                        [
                            2.8487205505371094,
                            42.01263432859156
                        ],
                        [
                            2.846231460571289,
                            42.01027472207946
                        ],
                        [
                            2.847003936767578,
                            42.0079150280354
                        ],
                        [
                            2.850780487060547,
                            42.006767037121335
                        ],
                        [
                            2.8530120849609375,
                            42.00638436887979
                        ],
                        [
                            2.8543853759765625,
                            42.00657570328826
                        ],
                        [
                            2.8579044342041016,
                            42.00504501190807
                        ],
                        [
                            2.860136032104492,
                            42.00561902549143
                        ],
                        [
                            2.8620243072509766,
                            42.00778747451241
                        ],
                        [
                            2.862710952758789,
                            42.007978804701
                        ],
                        [
                            2.863483428955078,
                            42.006894592690344
                        ],
                        [
                            2.8610801696777344,
                            42.00140947228087
                        ],
                        [
                            2.8658008575439453,
                            41.99777372492389
                        ],
                        [
                            2.8661441802978516,
                            41.99649797486623
                        ],
                        [
                            2.8657150268554688,
                            41.99477567172144
                        ],
                        [
                            2.8645992279052734,
                            41.994073979300026
                        ],
                        [
                            2.864856719970703,
                            41.99349986156474
                        ],
                        [
                            2.8682899475097656,
                            41.991649891411925
                        ],
                        [
                            2.875499725341797,
                            41.992415402824065
                        ],
                        [
                            2.8814220428466797,
                            41.99196885561915
                        ],
                        [
                            2.885713577270508,
                            41.99101195820239
                        ],
                        [
                            2.8961849212646484,
                            41.987567008393114
                        ],
                        [
                            2.89823936882732,
                            41.984385573807685
                        ],
                        [
                            2.89823936882732,
                            41.98437421955288
                        ],
                        [
                            2.8659725189208984,
                            41.96759538660669
                        ],
                        [
                            2.8614234924316406,
                            41.96868026812729
                        ],
                        [
                            2.8577327728271484,
                            41.968935531682405
                        ],
                        [
                            2.846403121948242,
                            41.967212482835436
                        ],
                        [
                            2.846403121948242,
                            41.96689339460133
                        ],
                        [
                            2.8391075134277344,
                            41.966638122863316
                        ],
                        [
                            2.838764190673828,
                            41.96625521333851
                        ],
                        [
                            2.8348159790039062,
                            41.96561702568286
                        ],
                        [
                            2.8347301483154297,
                            41.96446827179281
                        ],
                        [
                            2.833099365234375,
                            41.96421299033776
                        ],
                        [
                            2.833099365234375,
                            41.961404826824605
                        ],
                        [
                            2.83447265625,
                            41.95917097201442
                        ],
                        [
                            2.8331851959228516,
                            41.95853271339942
                        ],
                        [
                            2.8342151641845703,
                            41.95751148631874
                        ],
                        [
                            2.8336143493652344,
                            41.95604344371938
                        ],
                        [
                            2.8336143493652344,
                            41.954894517226904
                        ],
                        [
                            2.8343868255615234,
                            41.95380940096615
                        ],
                        [
                            2.8334426879882812,
                            41.95246893772611
                        ],
                        [
                            2.8337860107421875,
                            41.949149574088125
                        ],
                        [
                            2.832670211791992,
                            41.94870272347492
                        ],
                        [
                            2.829580307006836,
                            41.9492134096343
                        ],
                        [
                            2.827777862548828,
                            41.94857505129582
                        ],
                        [
                            2.826662063598633,
                            41.94685145185193
                        ],
                        [
                            2.8265762329101562,
                            41.94327643037303
                        ],
                        [
                            2.826061248779297,
                            41.942318801295045
                        ],
                        [
                            2.8238296508789062,
                            41.94097809642315
                        ],
                        [
                            2.820310592651367,
                            41.94008427751427
                        ],
                        [
                            2.819542295116656,
                            41.9383697734684
                        ],
                        [
                            2.819528366288657,
                            41.9383697734684
                        ],
                        [
                            2.8183364868164062,
                            41.93950967302834
                        ],
                        [
                            2.8179931640625,
                            41.94065887682254
                        ]
                    ]
                ]
                }
            }
            });

            map.addSource("Polvora", {
                type: 'geojson',
                data: {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                    [
                        [
                            2.8441286087036133,
                            41.97866669184123
                        ],
                        [
                            2.84421443939209,
                            41.97876240078671
                        ],
                        [
                            2.844514846801758,
                            41.97882620667042
                        ],
                        [
                            2.8446435928344727,
                            41.978539079690194
                        ],
                        [
                            2.8458023071289062,
                            41.97723104039784
                        ],
                        [
                            2.84646896297127,
                            41.97623983431367
                        ],
                        [
                            2.84646896297127,
                            41.976201753812724
                        ],
                        [
                            2.8458023071289062,
                            41.97592297423856
                        ],
                        [
                            2.843914031982422,
                            41.97404058798256
                        ],
                        [
                            2.8423690795898438,
                            41.973338667002594
                        ],
                        [
                            2.8423261642456055,
                            41.97353010076429
                        ],
                        [
                            2.8421545028686523,
                            41.973370572669495
                        ],
                        [
                            2.840909957885742,
                            41.97295579775309
                        ],
                        [
                            2.840094566345215,
                            41.971966708206224
                        ],
                        [
                            2.839794158935547,
                            41.971424297740356
                        ],
                        [
                            2.8394079208374023,
                            41.971009510149884
                        ],
                        [
                            2.8394508361816406,
                            41.97075425490556
                        ],
                        [
                            2.8388500213623047,
                            41.970690440934646
                        ],
                        [
                            2.838592529296875,
                            41.97053090572766
                        ],
                        [
                            2.8369617462158203,
                            41.97139239109853
                        ],
                        [
                            2.8366613388061523,
                            41.971679550299655
                        ],
                        [
                            2.83597469329834,
                            41.97190289544997
                        ],
                        [
                            2.83571720123291,
                            41.972190052349646
                        ],
                        [
                            2.8350305557250977,
                            41.97263673828709
                        ],
                        [
                            2.834644317626953,
                            41.97270055030813
                        ],
                        [
                            2.8339147567749023,
                            41.97266864430563
                        ],
                        [
                            2.8333139419555664,
                            41.97273245629472
                        ],
                        [
                            2.8331851959228516,
                            41.973211044175144
                        ],
                        [
                            2.83289472223885,
                            41.97376635418918
                        ],
                        [
                            2.83289472223885,
                            41.97378609411053
                        ],
                        [
                            2.835845947265625,
                            41.97400868265129
                        ],
                        [
                            2.8377771377563477,
                            41.975859165445996
                        ],
                        [
                            2.8374338150024414,
                            41.97601868730757
                        ],
                        [
                            2.8371334075927734,
                            41.97646534639435
                        ],
                        [
                            2.8370046615600586,
                            41.97700771393113
                        ],
                        [
                            2.836790084838867,
                            41.97719913666484
                        ],
                        [
                            2.836446762084961,
                            41.977805304859004
                        ],
                        [
                            2.836446762084961,
                            41.97799672519531
                        ],
                        [
                            2.836318016052246,
                            41.97812433843319
                        ],
                        [
                            2.836275100708008,
                            41.97882620667042
                        ],
                        [
                            2.836146354675293,
                            41.979017623938034
                        ],
                        [
                            2.838420867919922,
                            41.97975138480024
                        ],
                        [
                            2.8385496139526367,
                            41.97984709211545
                        ],
                        [
                            2.8391075134277344,
                            41.97975138480024
                        ],
                        [
                            2.8391504287719727,
                            41.97962377482287
                        ],
                        [
                            2.8394079208374023,
                            41.97949616458976
                        ],
                        [
                            2.839794158935547,
                            41.979464261991495
                        ],
                        [
                            2.839837074279785,
                            41.97933665143876
                        ],
                        [
                            2.840695381164551,
                            41.97920904063025
                        ],
                        [
                            2.841167449951172,
                            41.97933665143876
                        ],
                        [
                            2.8413820266723633,
                            41.97904952676001
                        ],
                        [
                            2.8417253494262695,
                            41.979017623938034
                        ],
                        [
                            2.842111587524414,
                            41.97914523513009
                        ],
                        [
                            2.8423261642456055,
                            41.97933665143876
                        ],
                        [
                            2.843012809753418,
                            41.97933665143876
                        ],
                        [
                            2.843012809753418,
                            41.97959187228858
                        ],
                        [
                            2.843356132507324,
                            41.97984709211545
                        ],
                        [
                            2.843613624572754,
                            41.97933665143876
                        ],
                        [
                            2.843785285949707,
                            41.97920904063025
                        ],
                        [
                            2.843785285949707,
                            41.978858109588316
                        ],
                        [
                            2.844085693359375,
                            41.97812433843319
                        ],
                        [
                            2.8441286087036133,
                            41.97866669184123
                        ]
                    ]
                ]
                    }
                }
            });

          


            // add a sky layer that will show when the map is highly pitched
            
            map.addLayer({
                'id': 'fill-Girona',
                'type': 'fill',
                'renderingMode': '2d',
                'source': 'Girona',
                'paint': {
                    "fill-color": "black",
                    "fill-opacity": 0,

                }
            },'settlement-major-label');
            
            map.addLayer({
                'id': 'border-Girona',
                'type': 'line',
                'renderingMode': '2d',
                'source': 'Girona',
                'paint': {
                    "line-color": "white",
                    "line-width": 3,
                    "line-opacity": 0,

                }
            },'settlement-major-label');

            map.addLayer({
                'id': 'border-GironaFi',
                'type': 'line',
                'renderingMode': '2d',
                'source': 'Girona',
                'paint': {
                    "line-color": "white",
                    "line-width": 1,
                    "line-opacity": 0,

                }
            },'settlement-major-label');

            map.addLayer({
                'id': 'fill-Polvora',
                'type': 'fill',
                'renderingMode': '2d',
                'source': 'Polvora',
                'paint': {
                    "fill-color": "black",
                    "fill-opacity": 0,

                }
            },'settlement-major-label');

            map.addLayer({
                'id': 'border-Polvora',
                'type': 'line',
                'renderingMode': '2d',
                'source': 'Polvora',
                'paint': {
                    "line-color": "white",
                    "line-width": 3,
                    "line-opacity": 0,

                }
            },'settlement-major-label');

            
           

            map.addControl(new mapboxgl.Minimap({
                id: "mapboxgl-minimap",
                width: "25vh",
                height: "25vh",
                style: "mapbox://styles/laur05/ckusajnmp54yy17pjowjqvd73",
                lineColor: "#b2182b",
                lineWidth: 1,
                lineOpacity: 1,
                fillColor: "#b2182b",
                fillOpacity: 0.25,
                center: { lon: -3.52701, lat: 40.14371 },
                zoom: 3,
                boxZoom: true,

                dragPan: false,

            }), 'bottom-right');

           // map.addControl(
               // new MapboxGeocoder({
               // accessToken: mapboxgl.accessToken,
               // mapboxgl: mapboxgl,
                //placeholder: 'Busca tu calle',
                //zoom: 7,
                //})
                //);



            // setup the instance, pass callback functions
            scroller
                .setup({
                    step: '.step',
                    offset: 0.5,
                    progress: true,
                    debug: false
                })
                .onStepEnter(response => {
                    var chapter = config.chapters.find(chap => chap.id === response.element.id);
                    response.element.classList.add('active');
                    map[chapter.mapAnimation || 'flyTo'](chapter.location);
                    if (config.showMarkers) {
                        marker.setLngLat(chapter.location.center);
                    }
                    if (chapter.onChapterEnter.length > 0) {
                        chapter.onChapterEnter.forEach(setLayerOpacity);
                    }
                    if (chapter.callback) {
                        window[chapter.callback]();
                    }
                    if (chapter.rotateAnimation) {
                        map.once('moveend', function () {
                            const rotateNumber = map.getBearing();
                            map.rotateTo(rotateNumber + 90, {
                                duration: 24000, easing: function (t) {
                                    return t;
                                }
                            });
                        });
                    }
                })
                .onStepExit(response => {
                    var chapter = config.chapters.find(chap => chap.id === response.element.id);
                    response.element.classList.remove('active');
                    if (chapter.onChapterExit.length > 0) {
                        chapter.onChapterExit.forEach(setLayerOpacity);
                    }
                });
        });

        // setup resize event
        window.addEventListener('resize', scroller.resize);

    </script>
</body>
</html>